name: Fix Build Nezha Agent (ppp0 Only)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: nezhahq/agent
          ref: main

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'

      - name: Patch Code (Smart Logic Flip)
        run: |
          echo "ğŸ” æ­£åœ¨å¯»æ‰¾å¹¶ä¿®æ”¹ç½‘ç»œç›‘æ§é€»è¾‘..."
          
          # æ ¸å¿ƒé€»è¾‘ï¼š
          # 1. æœç´¢ pkg ç›®å½•ä¸‹åŒ…å« == "lo" çš„æ–‡ä»¶ï¼ˆè¿™é€šå¸¸æ˜¯æ’é™¤å›ç¯å£çš„é€»è¾‘ï¼‰
          # 2. ç›´æ¥å°† '== "lo"' æ›¿æ¢ä¸º '!= "ppp0"'
          # 3. é€»è¾‘å˜åŒ–ï¼šä» "æ˜¯loå°±è·³è¿‡" å˜æˆäº† "ä¸æ˜¯ppp0å°±è·³è¿‡" -> ä¹Ÿå°±æ˜¯åªä¿ç•™ ppp0
          
          grep -rl '== "lo"' pkg | xargs sed -i 's/== "lo"/!= "ppp0"/g'
          
          echo "âœ… ä¿®æ”¹å®Œæˆï¼è®©æˆ‘ä»¬çœ‹çœ‹æ”¹äº†å“ªé‡Œï¼ˆä»¥æ­¤éªŒè¯æ˜¯å¦æˆåŠŸï¼‰ï¼š"
          git diff

      - name: Build ARM64 Binary
        run: |
          cd cmd/agent
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags "-s -w -extldflags '-static'" -o nezha-agent-v1-ppp0

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nezha-agent-v1-ppp0-be86u
          path: cmd/agent/nezha-agent-v1-ppp0
