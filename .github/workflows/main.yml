name: Build Nezha Agent V1 (Debug & Fix)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: nezhahq/agent
          ref: main

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'

      - name: Locate and Patch Monitor Code
        run: |
          echo "ğŸ” æ­£åœ¨å…¨ç›˜æœç´¢ç½‘ç»œç›‘æ§ä»£ç ..."
          
          # 1. å¯»æ‰¾åŒ…å« IOCounters (è·å–ç½‘å¡æµé‡çš„å‡½æ•°) çš„æ–‡ä»¶
          # ä½¿ç”¨ || true é˜²æ­¢æ‰¾ä¸åˆ°æ—¶æŠ¥é”™é€€å‡º
          TARGET_FILE=$(grep -rl "IOCounters" . || true)
          
          if [ -z "$TARGET_FILE" ]; then
            echo "âš ï¸ è­¦å‘Šï¼šæ²¡æ‰¾åˆ° IOCounters å…³é”®å­—ï¼Œå°è¯•æœç´¢ 'lo' å…³é”®å­—..."
            TARGET_FILE=$(grep -rl '"lo"' . | grep ".go" || true)
          fi

          if [ -z "$TARGET_FILE" ]; then
            echo "âŒ ä¸¥é‡é”™è¯¯ï¼šæ‰¾ä¸åˆ°ä»»ä½•ç›‘æ§ç›¸å…³çš„ä»£ç æ–‡ä»¶ã€‚å¯èƒ½å®˜æ–¹æ”¹äº†å˜é‡åã€‚"
            exit 1
          fi
          
          echo "âœ… é”å®šç›®æ ‡æ–‡ä»¶: $TARGET_FILE"
          echo "ğŸ“„ æ‰“å°æ–‡ä»¶åŸå§‹å†…å®¹ï¼ˆç”¨äºæ’é”™ï¼‰ï¼š"
          cat "$TARGET_FILE"
          
          echo "ğŸ› ï¸ å¼€å§‹åº”ç”¨è¡¥ä¸..."
          
          # æ ¸å¿ƒé­”æ³•ï¼šç›´æ¥æŠŠæ‰€æœ‰ '== "lo"' (æ˜¯loåˆ™...) æ›¿æ¢ä¸º '!= "ppp0"' (ä¸æ˜¯ppp0åˆ™...)
          # è¿™æ ·å°±å®ç°äº†ï¼šå¦‚æœä¸æ˜¯ ppp0ï¼Œå°±æ‰§è¡Œåé¢çš„ continue (è·³è¿‡)
          # æˆ‘ä»¬åŒæ—¶åŒ¹é…åŒå¼•å· "lo" å’Œå•å¼•å· 'lo' ä»¥é˜²ä¸‡ä¸€
          
          sed -i 's/== "lo"/!= "ppp0"/g' "$TARGET_FILE"
          sed -i "s/== 'lo'/!= 'ppp0'/g" "$TARGET_FILE"
          
          echo "ğŸ‰ è¡¥ä¸åº”ç”¨å®Œæˆï¼æ£€æŸ¥ä¿®æ”¹ç‚¹ï¼š"
          git diff

      - name: Build ARM64 Binary
        run: |
          cd cmd/agent
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags "-s -w -extldflags '-static'" -o nezha-agent-v1-ppp0

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nezha-agent-v1-ppp0-be86u
          path: cmd/agent/nezha-agent-v1-ppp0
