name: Build Nezha Agent V1 (Source Code Fixed)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: nezhahq/agent
          ref: main

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'

      - name: Patch NIC Code (Inject Filter)
        run: |
          TARGET_FILE="pkg/monitor/nic/nic.go"
          
          echo "ğŸ¯ ç›®æ ‡æ–‡ä»¶: $TARGET_FILE"
          
          # æ ¸å¿ƒä¿®æ”¹é€»è¾‘ï¼š
          # æºç ç¬¬ 42 è¡Œæ˜¯: for _, v := range nc {
          # æˆ‘ä»¬åˆ©ç”¨ sed å°†å…¶æ›¿æ¢ä¸º: for _, v := range nc { if v.Name != "ppp0" { continue }
          # è¿™æ ·ï¼Œåœ¨è¿›å…¥ä»»ä½•å®˜æ–¹åˆ¤æ–­é€»è¾‘ä¹‹å‰ï¼Œåªè¦ä¸æ˜¯ ppp0ï¼Œç›´æ¥è¢«è¸¢å‡ºï¼Œæ— æ³•è®¡å…¥æµé‡ã€‚
          
          sed -i 's/for _, v := range nc {/for _, v := range nc { if v.Name != "ppp0" { continue }/g' "$TARGET_FILE"
          
          echo "âœ… ä»£ç ä¿®æ”¹å®Œæˆï¼å·®å¼‚å¦‚ä¸‹ï¼š"
          git diff

      - name: Build ARM64 Binary
        run: |
          cd cmd/agent
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags "-s -w -extldflags '-static'" -o nezha-agent-v1-ppp0

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nezha-agent-v1-ppp0-be86u
          path: cmd/agent/nezha-agent-v1-ppp0
