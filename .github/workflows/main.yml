name: Build Nezha Agent V1 for BE86U (ppp0 Only)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout V1 Agent Code
        uses: actions/checkout@v4
        with:
          repository: nezhahq/agent  # ğŸ‘ˆ è¿™é‡Œæ”¹æˆäº†æ–°ç‰ˆç‹¬ç«‹ä»“åº“
          ref: main                  # ä½¿ç”¨æœ€æ–°ä»£ç 

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'         # V1 é€šå¸¸éœ€è¦æ›´æ–°çš„ Go ç‰ˆæœ¬

      - name: Patch Agent (Whitelist ppp0)
        run: |
          echo "æ­£åœ¨ä¿®æ”¹æºç ..."
          # ç­–ç•¥ï¼šV1 Agent çš„ç›‘æ§ä»£ç é€šå¸¸åœ¨ pkg/monitor é™„è¿‘
          # æˆ‘ä»¬æŸ¥æ‰¾åŒ…å« "lo" (å›ç¯) å’Œ "continue" çš„è¡Œï¼Œè¿™é€šå¸¸æ˜¯è¿‡æ»¤é€»è¾‘
          # ç„¶åå°†å…¶å¼ºè¡Œæ›¿æ¢ä¸ºï¼šå¦‚æœç½‘å¡åä¸æ˜¯ ppp0ï¼Œå°± continue (è·³è¿‡)
          
          # 1. æŸ¥æ‰¾å¹¶æ›¿æ¢ (ä½¿ç”¨æ›´é€šç”¨çš„æ­£åˆ™ï¼Œé€‚é… V1 çš„å˜é‡åå¯èƒ½æ˜¯ n.Name æˆ– nic.Name)
          grep -rl '== "lo".*continue' . | xargs sed -i 's/if .* == "lo".*continue/if n.Name != "ppp0" { continue }/g'
          
          # 2. ä»¥é˜²ä¸‡ä¸€å˜é‡åæ˜¯ nic æˆ– ioï¼Œåšä¸ªå¤‡ç”¨æ›¿æ¢ï¼ˆGo ç¼–è¯‘å™¨ä¼šå¿½ç•¥æ— æ•ˆçš„æ›¿æ¢ï¼Œå› ä¸ºåªç”Ÿæ•ˆä¸€ä¸ªï¼‰
          grep -rl '== "lo".*continue' . | xargs sed -i 's/if .* == "lo".*continue/if nic.Name != "ppp0" { continue }/g'
          grep -rl '== "lo".*continue' . | xargs sed -i 's/if .* == "lo".*continue/if io.Name != "ppp0" { continue }/g'

          echo "ä¿®æ”¹å®Œæˆï¼Œå·®å¼‚æ£€æŸ¥ï¼š"
          git diff

      - name: Build ARM64 Binary
        run: |
          # V1 çš„å…¥å£é€šå¸¸åœ¨ cmd/agent
          cd cmd/agent
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags "-s -w -extldflags '-static'" -o nezha-agent-v1-ppp0

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nezha-agent-v1-ppp0-be86u
          path: cmd/agent/nezha-agent-v1-ppp0
