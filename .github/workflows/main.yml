name: Build Nezha Agent V1 (Final Fix)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: nezhahq/agent
          ref: main

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'

      - name: Patch Monitor Code (Targeted Fix)
        run: |
          # æˆ‘ä»¬å·²ç»ç¡®è®¤äº†æ ¸å¿ƒæ–‡ä»¶è·¯å¾„ï¼Œç›´æ¥ç²¾å‡†ä¿®æ”¹
          TARGET_FILE="pkg/monitor/nic/nic.go"
          
          echo "ğŸ¯ ç›®æ ‡é”å®š: $TARGET_FILE"
          
          # 1. ç®€å•æš´åŠ›çš„é€»è¾‘åè½¬ï¼š
          # åŸç†ï¼šæºç é‡Œä¸€å®šæœ‰ä¸€å¥åˆ¤æ–­ '== "lo"' (å¦‚æœæ˜¯å›ç¯loï¼Œå°±è·³è¿‡/continue)
          # æˆ‘ä»¬æŠŠå®ƒæ”¹æˆ '!= "ppp0"' (å¦‚æœä¸æ˜¯ ppp0ï¼Œå°±è·³è¿‡/continue)
          # è¿™æ ·å°±å®ç°äº†ã€åªç›‘æ§ ppp0ã€‘
          
          sed -i 's/== "lo"/!= "ppp0"/g' "$TARGET_FILE"
          
          # åŒé‡ä¿é™©ï¼šæœ‰äº›ä»£ç å¯èƒ½å†™çš„æ˜¯ if "lo" == ...
          sed -i 's/"lo" ==/"ppp0" !=/g' "$TARGET_FILE"
          
          echo "âœ… ä¿®æ”¹å®Œæˆï¼å·®å¼‚å¦‚ä¸‹ï¼š"
          git diff

      - name: Build ARM64 Binary
        run: |
          cd cmd/agent
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags "-s -w -extldflags '-static'" -o nezha-agent-v1-ppp0

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nezha-agent-v1-ppp0-be86u
          path: cmd/agent/nezha-agent-v1-ppp0
